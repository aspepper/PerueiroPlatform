generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String               @id @default(cuid())
  email       String               @unique
  password    String
  name        String?
  role        Role                 @default(ADMIN)
  driver      Driver?              @relation("DriverAccount")
  guardian    Guardian?            @relation("GuardianAccount")
  resetTokens PasswordResetToken[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

enum Role {
  ADMIN
  DRIVER
  GUARDIAN
}

model Guardian {
  cpf         String    @id
  name        String
  kinship     String
  birthDate   DateTime?
  spouseName  String?
  address     String
  mobile      String
  landline    String?
  workAddress String?
  workPhone   String?
  students    Student[]
  user        User?     @relation("GuardianAccount", fields: [userId], references: [id])
  userId      String?   @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model School {
  id        BigInt    @id @default(autoincrement())
  name      String
  address   String
  phone     String?
  contact   String?
  principal String?
  doorman   String?
  students  Student[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Driver {
  cpf       String    @id
  name      String
  cnh       String?
  phone     String?
  email     String?
  address   String?
  vans      Van[]
  students  Student[] @relation("DriverStudents")
  user      User?     @relation("DriverAccount", fields: [userId], references: [id])
  userId    String?   @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Van {
  id         BigInt    @id @default(autoincrement())
  model      String
  color      String?
  year       String?
  plate      String    @unique
  driverCpf  String?
  driver     Driver?   @relation(fields: [driverCpf], references: [cpf])
  billingDay Int       @default(10)
  monthlyFee Decimal   @default(0) @db.Decimal(12, 2)
  students   Student[]
  payments   Payment[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
}

model Student {
  id          BigInt    @id @default(autoincrement())
  name        String
  birthDate   DateTime?
  grade       String?
  guardianCpf String?
  guardian    Guardian? @relation(fields: [guardianCpf], references: [cpf])
  schoolId    BigInt?
  school      School?   @relation(fields: [schoolId], references: [id])
  vanId       BigInt?
  van         Van?      @relation(fields: [vanId], references: [id])
  driverCpf   String?
  driver      Driver?   @relation("DriverStudents", fields: [driverCpf], references: [cpf])
  mobile      String?
  blacklist   Boolean   @default(false)
  payments    Payment[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model Payment {
  id        BigInt        @id @default(autoincrement())
  studentId BigInt
  student   Student       @relation(fields: [studentId], references: [id])
  vanId     BigInt?
  van       Van?          @relation(fields: [vanId], references: [id])
  dueDate   DateTime
  paidAt    DateTime?
  amount    Decimal       @db.Decimal(12, 2)
  discount  Decimal       @default(0) @db.Decimal(12, 2)
  status    PaymentStatus @default(PENDING)
  boletoId  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  @@index([studentId, dueDate])
  @@index([vanId, dueDate])
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId, expiresAt])
}
